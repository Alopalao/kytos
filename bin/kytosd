#!/usr/bin/env python3.6
"""Start Kytos SDN Platform core."""
import daemon
import IPython
import signal

from IPython.terminal.embed import InteractiveShellEmbed
from IPython.terminal.prompts import Prompts, Token
from kytos.core import Controller
from kytos.core.config import KytosConfig


class KytosPrompt(Prompts):
     def in_prompt_tokens(self, cli=None):
         return [(Token.Prompt, 'kytos $> ')]

controller = None
kill_handler = None

banner1 = """Welcome to Kytos SDN Platform!

We are doing a huge effort to make sure that this console will work fine. But
for now is still experimental.

Please be patient!"""

def stop_controller(signum, frame):
    """Stop the controller before quitting."""
    if controller:
        print('Stopping controller...')
        # If stop() hangs, old ctrl+c behaviour will be restored
        signal.signal(signal.SIGINT, kill_handler)
        controller.stop()


kill_handler = signal.signal(signal.SIGINT, stop_controller)

if __name__ == '__main__':
    config = KytosConfig()
    controller = Controller(config.options['daemon'])
    if controller.options.foreground:
        controller.start()
        ipshell = InteractiveShellEmbed(banner1=banner1)
        ipshell.prompts = KytosPrompt(ipshell)
        ipshell()
        controller.stop()
    else:
        with daemon.DaemonContext():
            controller.start()
        print('Kytos daemon started.')
